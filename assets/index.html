<html>
    <head>
        <meta charset="UTF-8">
        <title>Global Explorer</title>
        <link rel="stylesheet" href="main.css">
        <script src="utils.js"></script>
        <script src="core.js"></script>
        <script src="render.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"
            integrity="sha512-L03kznCrNOfVxOUovR6ESfCz9Gfny7gihUX/huVbQB9zjODtYpxaVtIaAkpetoiyV2eqWbvxMH9fiSv5enX7bw=="
            crossorigin="anonymous"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js" crossorigin="anonymous"></script>
        <script src="components/ge-action.js"></script>
        <script src="components/ge-base.js"></script>
        <script src="components/ge-credit-card.js"></script>
        <script src="components/ge-info.js"></script>
    </head>
    <body>
        <div id="app" class="visible">
            <ge-base
                :title="content.title"
                :content-transform="contentTransform"
                :content="content.markdown"
                :title-image="content.titleImage"
                :background="content.background"
                :actions="content.actions"
                :type="content.type"
                :on-action="onAction"
            ></ge-base>
            <div class="account" id="account" v-bind:class="{closed: !showPlayer}">
                <ge-info title="Time" :value="game.time"></ge-info>
                <ge-credit-card
                    :issuer="player.account.card_issuer"
                    :number="player.account.card_number"
                    :name="player.name"
                ></ge-credit-card>
                <ge-info title="Account balance" :value="player.account.balance"></ge-info>
            </div>
        </div>
    </body>
    <script>
async function setup() {
    const markdownConverter = new showdown.Converter()
    const transform = (markdown) => {
        return markdownConverter.makeHtml(markdown)
    }
    const app = new Vue({
        el: "#app",
        data: {
            content: {},
            player: {
                name: "John Stirling",
                account: {
                    card_issuer: "VISA",
                    card_number: "2222 2222 2222 2222"
                }
            },
            game: {
                time: "19:00"
            },
            showPlayer: false,
            contentTransform: transform,
            onAction(a) {
                console.log(a)
            }
        },
    })
    const urlParams = new URLSearchParams(window.location.search)
    const savedSessionId = urlParams.get('session_id') || window.localStorage.getItem("global_explorer_session")
    const core = await GlobalExplorer.from_websocket(
        `ws://${window.location.hostname}:5000/`,
        () => {
            console.log(core.version)
            console.log(core.player)
            console.log(core.content)
            console.log(core.game)
            app.game = core.game || {time: "- - -"}
            app.player = core.player || {
                name: "John Doe",
                account: {
                    card_issuer: "NOOP",
                    card_number: "---- ---- ---- ----"
                }
            }
            app.showPlayer = !!core.player
            app.content = core.content
        },
        savedSessionId
    );
    app.onAction = (action, value) => {
        console.log(action, value)
        core.action(action, value)
    }
    core.init().then(() => {
        const sessionId = core.api.sessionId
        if (sessionId) {
            window.localStorage.setItem("global_explorer_session", sessionId)
        }
    })
}
setup()
    </script>
</html>